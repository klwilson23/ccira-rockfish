#devtools::install_github("James-Thorson-NOAA/FishLife")
library(FishLife)
library(TMB)

normalize <- function(x, na.rm = TRUE) {
  return((x- 0) /(max(x, na.rm = TRUE)-0))
}

rockfish_spp <- c("black","blackspotted","bocaccio","brown","canary","china","copper","deacon","dusky-dark","greenstripe","puget sound","pygmy","quillback","redbanded","redstripe","rosethorn","sebastolobus","sharpchin","shortbelly","shortraker","silvergray","splitnose","stripetail","tiger","vermillion","widow","yelloweye","yellowtail")

rockfish_vuln <- read.csv("Data/Fish life histories for scoring.csv")
rockfish_vuln <- rockfish_vuln[,-ncol(rockfish_vuln)]

thorson_traits <- as.data.frame(FishLife::FishBase_and_RAM$beta_gv)
thorson_covar <- as.data.frame(FishLife::FishBase_and_RAM$Cov_gvv)
thorson_covar <- thorson_covar[,intersect(colnames(thorson_covar),paste(colnames(thorson_traits),".",colnames(thorson_traits),sep=""))]
colnames(thorson_covar) <- colnames(thorson_traits)
leading_traits <- c("Loo","K","Winfinity","tmax","tm","M","Lm","ln_var","ln_MASPS","ln_margsd","ln_Fmsy_over_M","ln_Fmsy")
thorson_traits[,leading_traits] <- exp(thorson_traits[,leading_traits]+0.5*thorson_covar[,leading_traits])
taxa <- "Actinopterygii_Scorpaeniformes_Sebastidae"
rockfish_rows <- row.names(thorson_traits)[grep(taxa,row.names(thorson_traits))]
rockfish <- thorson_traits[rockfish_rows,]
rockfish[,c("Loo","K","tmax","tm","M","h","r","ln_Fmsy_over_M","ln_Fmsy","G")]

plot(r~tmax,data=rockfish,xlab="Maximum age (all Sebastidae)",ylab="Intrinsic rate of growth",pch=21,bg="grey90")
m1 <- glm(r~log(tmax),family=gaussian(link="log"),data=rockfish)
summary(m1)
curve(exp(coef(m1)[1] + coef(m1)[2]*log(x)),add=TRUE)
summary(lm(log(r)~log(tmax),data=rockfish))
rockfish_vuln$tmax <- rockfish_vuln$Max.Age
rockfish_vuln$r <- predict(m1,newdata = rockfish_vuln,type="r")
rockfish_vuln$vuln <- 100*normalize(1/rockfish_vuln$r)
plot(vuln~Vulnerability.Cheung,data=rockfish_vuln)
plot(vuln~Vulnerability.Magnuson,data=rockfish_vuln)
summary(lm(vuln~Vulnerability.Magnuson,data=rockfish_vuln))
