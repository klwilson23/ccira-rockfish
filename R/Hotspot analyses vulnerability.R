#devtools::install_github("James-Thorson-NOAA/FishLife")
library(FishLife)
library(TMB)
library(dplyr)

normalize <- function(x, na.rm = TRUE) {
  return((x- 0) /(max(x, na.rm = TRUE)-0))
}

rockfish_spp <- c("black","blackspotted","bocaccio","brown","canary","china","copper","deacon","dusky-dark","greenstripe","puget sound","pygmy","quillback","redbanded","redstripe","rosethorn","sebastolobus","sharpchin","shortbelly","shortraker","silvergray","splitnose","stripetail","tiger","vermillion","widow","yelloweye","yellowtail")

rockfish_vuln <- read.csv("Data/Fish life histories for scoring.csv")
rockfish_vuln <- rockfish_vuln[,-ncol(rockfish_vuln)]
rockfish_vuln$Common.name[rockfish_vuln$Common.name=="silvergrey"] <- "silvergray"
rockfish_ncc <- read.csv("Data/rockfish normalized cpue by site and species.csv",header=TRUE)


thorson_traits <- as.data.frame(FishLife::FishBase_and_RAM$beta_gv)
thorson_covar <- as.data.frame(FishLife::FishBase_and_RAM$Cov_gvv)
thorson_covar <- thorson_covar[,intersect(colnames(thorson_covar),paste(colnames(thorson_traits),".",colnames(thorson_traits),sep=""))]
colnames(thorson_covar) <- colnames(thorson_traits)
leading_traits <- c("Loo","K","Winfinity","tmax","tm","M","Lm","ln_var","ln_MASPS","ln_margsd","ln_Fmsy_over_M","ln_Fmsy")
thorson_traits[,leading_traits] <- exp(thorson_traits[,leading_traits]+0.5*thorson_covar[,leading_traits])
taxa <- "Actinopterygii_Scorpaeniformes_Sebastidae"
rockfish_rows <- row.names(thorson_traits)[grep(taxa,row.names(thorson_traits))]
rockfish <- thorson_traits[rockfish_rows,]
rockfish[,c("Loo","K","tmax","tm","M","h","r","ln_Fmsy_over_M","ln_Fmsy","G")]

plot(r~tmax,data=rockfish,xlab="Maximum age (all Sebastidae)",ylab="Intrinsic rate of growth",pch=21,bg="grey90",ylim=c(0,1))
m1 <- glm(r~log(tmax),family=gaussian(link="log"),data=rockfish)
summary(m1)
curve(exp(coef(m1)[1] + coef(m1)[2]*log(x)),add=TRUE)
summary(lm(log(r)~log(tmax),data=rockfish))
summary(lm(log(r)~log(tmax)+log(K),data=rockfish))

rockfish_vuln$tmax <- rockfish_vuln$Max.Age
rockfish_vuln$r <- predict(m1,newdata = rockfish_vuln,type="r")
rockfish_vuln$vuln <- 1*normalize(1/rockfish_vuln$r)
plot(vuln~Vulnerability.Cheung,data=rockfish_vuln)
plot(vuln~Vulnerability.Magnuson,data=rockfish_vuln)
summary(lm(vuln~Vulnerability.Magnuson,data=rockfish_vuln))

plot(1/r~tmax,data=rockfish_vuln,xlab="Maximum age (all Sebastidae)",ylab="Inverse of Rmax",pch=21,bg="grey90")

rockfish_ncc$vuln <- rockfish_vuln$vuln[match(rockfish_ncc$species,rockfish_vuln$Common.name)]
rockfish_ncc$trophic <- 1*normalize(rockfish_vuln$Trophic.level[match(rockfish_ncc$species,rockfish_vuln$Common.name)])
rockfish_ncc$depletion<- 1*normalize(1-rockfish_vuln$By.B0[match(rockfish_ncc$species,rockfish_vuln$Common.name)])
rockfish_ncc$evo_dist<- 1*normalize(rockfish_vuln$Evolutionary.Distinctiveness[match(rockfish_ncc$species,rockfish_vuln$Common.name)])
weights <- c(4,4,2,4,2) # lambda, vulnerability, trophic level, depletion, evolutionary distinctiveness
rockfish_ncc$scores <- rowSums(t(weights*t(cbind(rockfish_ncc$normalized_lambda,rockfish_ncc$vuln,rockfish_ncc$trophic,rockfish_ncc$depletion,rockfish_ncc$evo_dist))),na.rm=TRUE)
rockfish_ncc$total <- rowSums(t(weights*t(!is.na(cbind(rockfish_ncc$normalized_lambda,rockfish_ncc$vuln,rockfish_ncc$trophic,rockfish_ncc$depletion,rockfish_ncc$evo_dist)))),na.rm=TRUE)
rockfish_ncc$rockfish_hotspot <- rockfish_ncc$scores/rockfish_ncc$total

hotspots_coast <- aggregate(rockfish_hotspot~PU_4Km_ID,data=rockfish_ncc,function(x){sum(x)/length(x)})
hotspots_coast$composite_score <- normalize(hotspots_coast$rockfish_hotspot)
hotspots_coast <- hotspots_coast %>%
  mutate(rockfish_hotspot_rank = ntile(composite_score, 10))

table(hotspots_coast$rockfish_hotspot_rank)
hotspots_coast[hotspots_coast$PU_4Km_ID=="6267",]

oldhotties <- c("6267","7524","7997","8003",
                "8157","8159","8629","8783",
                "9259","9265","9731","9733",
                "10524","10674","10675","11331",
                "11629","11774","11789","11944",
                "12093","12242","12410","12741",
                "12895","12897","13034","13055","13213")

sum(hotspots_coast[hotspots_coast$PU_4Km_ID%in%oldhotties,"rockfish_hotspot_rank"]>=9)
hotspots_coast[hotspots_coast$PU_4Km_ID%in%oldhotties,]
boc_hotties <- rockfish_ncc[rockfish_ncc$species%in%"bocaccio" & rockfish_ncc$normalized_lambda>=0.7,"PU_4Km_ID"]

hotspots_coast[hotspots_coast$PU_4Km_ID%in%boc_hotties,]
rockfish_ncc[rockfish_ncc$PU_4Km_ID%in%boc_hotties,1:5]

write.csv(hotspots_coast,"Data/Rockfish hotspots.csv")
